{% extends 'patient/appt_1.html' %}
{% load static %}

{% block header %}
<link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />

<link rel="stylesheet" href="//fonts.googleappis.com/css?family=Roboto:300,400,500,700|Material+Icons">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
<script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>

<link rel="stylesheet" href="{% static 'css/appt_2.css' %}">
<script src="{% static 'js/appointment.js' %}"></script>

<style>
    #div_slot {
        display: none;
    }

    #time_slot {
        display: flex;
    }

    .session-btn {
        width: 160px;
        padding: 10px;
        margin: 10px;
        height: 60px;
        font-size: 14px;
        border-radius: 10px;
    
    }


    #err_div {
        display: none;
        color: red;
        text-align: center;
        margin-top: 20px;
        font-size: 30px;
    }
</style>

{% endblock %}


{% block content %}

<!-- row start  -->
<div class="row d-flex h-100 dr_details">

    <div class="col-1 arw">
        <a href="{% url 'patient:appointment_1' %}"> <span class="material-symbols-outlined btn" id="arrow_left">
                keyboard_arrow_left
            </span></a>
    </div>

    <div class="col-5">
        <div class="card" style="border-radius: 15px;">
            <div class="card-body p-4">
                <div class="d-flex text-black">
                    <div class="flex-shrink-0">
                        <img src="https://care.bestdocapp.com/_nuxt/img/male_doctor.7fec7ec.svg"
                            alt="Generic placeholder image" class="img-fluid"
                            style="width: 80px; height: 80px; border-radius: 10px;" />
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="mt-4 mb-1">Dr. {{ doctor.doctor_name | title }} ({{ doctor.qualification | upper }} )
                        </h5>
                        <span><input type="hidden" name="dr_id" id="dr_id" value="{{ doctor.id }}"></span>
                        <p class="mb-2 pb-1" style="color: #2b2a2a;">

                            {{ doctor.department.department | upper }}
                        </p>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-4"></div>

    <div class="col-2">
        <div class="card fees">
            <div class="card-body p-4">
                <div class="v-card" style="width: 150px;">
                    <span class="body-1">Fee*</span> <br>
                    <span class="title"> <b>â‚¹{{ doctor.fee }}</b> </span>
                </div>
            </div>
        </div>
    </div>

</div>
<!-- row end  -->

<!-- row start  -->

<div class="row">
    <div class="col-md-12">

        <p>Available Days : </p>
        <p>


        <table>
            <tr>
                <th>Day</th>
                <th>Time</th>
            </tr>
            {% for record in consultation %}

            <tr>

                <td>{{ record.day |title }}</td>
                <td>{{ record.time }}</td>
            </tr>

            {% endfor %}
        </table>

        </p>

    </div>
</div>

<div class="row">
    <div class="col-4"></div>
    <div class="col-4">
        <form>
            <div class="md-form md-outline input-with-post-icon datepicker">
                <label for="date">Consultation Date</label>
                <input placeholder="Select date" type="date" id="consultation_date" name="consultation_date"
                    class="form-control">
            </div>
        </form>
    </div>
    <div class="col-4"></div>
</div>
<!-- row end  -->

<!-- row start  -->

<div id="div_slot">

    <div class="row slot">
        <div class="col-12">
            <p> Available Slots/Tokens </p>
        </div>
    </div>
    <!-- row end  -->

    <hr class="bg-dark border-2 border-top border-dark w-70" style="margin-left: 10px;">

    <!-- row start  -->
    <div class="row slot">
        <div class="col-1"></div>
        <div class="col-1" id="time_slot">
            <button type="button" class="btn btn-outline-light" id="style">04:00 pm</button>
        </div>

        <div class="col-1"></div>
    </div>



    <div class="row slot">
        <div class="col-5"></div>
        <div class="col-2">
            <a href="{% url 'patient:appointment_3' %}" class="btn btn-primary">PROCEED</a>
        </div>
        <div class="col-5"></div>
    </div>
</div>
<div id="err_div">Doctor Not Available For Selected Date</div>

<script>
    var session_div = document.getElementById('time_slot')
    var query_string = window.location.search
    var urlParamsArr = new URLSearchParams(query_string)
    var dr_id = urlParamsArr.get('dr')
    console.log(dr_id)
    var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    $('#consultation_date').change(function () {

        var dt = new Date($('#consultation_date').val())
        var selected_day = days[dt.getDay()]
        $('#time_slot').empty()
        console.log(selected_day)
        console.log($(this).val())
        $.ajaxSetup({
            headers: {
                "X-CSRFToken": '{{csrf_token}}'
            }
        })

        $.ajax({

            url: "{% url 'patient:check-availability' %}",
            type: 'POST',
            data: {
                dr_id: dr_id,
                'selected_day': selected_day
            },

            success: function (response) {

                let status = response.availability
                var records = response.consultation_record


                if (status == true) {

                    $('#div_slot').show()
                    $('#err_div').hide()

                    let records = response.consultation_record

                    console.log(response.consultation_record)

                    for (var i = 0; i < records.length; i++) {
                        let obj = records[i]

                        console.log(obj)

                        for (let j in obj) {

                            console.log('key', obj[j])

                            let arr = obj[j]
                            for (let k = 0; k < arr.length; k++) {
                                let btn = document.createElement("button")
                                btn.setAttribute('class','session-btn btn-border')
                                
                                btn.innerHTML = arr[k]
                                session_div.append(btn)
                            }   
                        }



                    }


                }

                else {
                    $('#div_slot').hide()
                    $('#err_div').show()
                    console.log('no')
                }
            }


        })
    })
</script>

{% endblock %}